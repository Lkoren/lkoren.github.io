---
layout: default
title: Local STL file preview with JSC3D
---
<link rel="stylesheet" type="text/css" href="{{site.baseurl}}assets/2013-10-23/css/canvas.css" media="screen, handheld" />

#Previewing 3D files locally.

### <span class = "date">23 Oct 2013</span>

I've been working a STL quotation service for Andre Tiemann, of Draftprint3D. The Draftprint site already used JSC3D, a canvas-based Javascript 3d library that I wasn't familiar with. JSC3D is definately an interesting looking project, but it's still fairly young, and not as well documented as it could be.

One feature I really wanted to be able to implement for Andre was local previewing of 3d CAD files. It would have been fairly straight-forward to shoot the files up to the server and then transfer them back to the preview page -- this in fact does happen eventually in order to process the file for quoting, however it seemed insane to have to hit to server in order for the user to just get a preview of the file.

Using the File API, it was relatively easy to get local preview working, however there were one or two non-obvious things -- I had to spend a while poking through JSC3D source in order to figure it out, and I needed a pointer from Humu, JSC's maintainer, to fix one bug in the code.

<div class = "canvas" id = "canvas-drop">
    <canvas id = "upload_canvas" width = "480" height="320" style="border: 1px solid;"></canvas>
</div>

<div id="dropzone">
    <p>You can drag and drop an STL file into this target.</p>
</div>


Here's how to get JSC3D to load a local file:

{% highlight javascript %}
var viewer = new JSC3D.Viewer(mycanvas)
  var handle_file_select = function(e) {
    e.stopPropagation()
    e.preventDefault()
    var f = e.target.files[0]
    preview_stl(f)
  }

  function preview_stl(f) {
    var theScene
    var stl_loader
    var reader = new FileReader()
    var ext = f.name.split(".")[1]

    function setup_viewer() {
      viewer.setParameter('InitRotationX', 20);
      viewer.setParameter('InitRotationY', 20);
      viewer.setParameter('InitRotationZ', 0);
      viewer.setParameter('ModelColor', '#CAA618');
      viewer.setParameter('BackgroundColor1', '#FFFFFF');
      viewer.setParameter('BackgroundColor2', '#383840');
      viewer.setParameter('RenderMode', "flat");
    }
    setup_viewer()

    reader.onload = (function(file) {
      return function(e) {
        theScene = new JSC3D.Scene
          stl_loader = new JSC3D.StlLoader()
          stl_loader.parseStl(theScene, e.target.result)
            viewer.init()
            viewer.replaceScene(theScene)
            viewer.update()
      }
    })(f)

    if (ext.toLowerCase() != "stl") {
      alert("That doesn't appear to be an STL file.");
    } else {
      reader.readAsBinaryString(f)
    }
  }
{% endhighlight %}

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript" src ="{{site.baseurl}}assets/2013-10-23/js/jsc3d.js"></script>
<script type="text/javascript" src ="{{site.baseurl}}assets/2013-10-23/js/stl_viewer.js"></script>

